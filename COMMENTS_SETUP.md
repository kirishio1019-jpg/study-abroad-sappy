# コメント機能のセットアップガイド

各レビューに対してコメントを投稿できる機能を追加しました。匿名または名前付きで選択できます。

---

## ✅ 実装した機能

### 1. コメント投稿
- ✅ レビューに対してコメントを投稿可能
- ✅ 匿名または名前付きで選択可能
- ✅ ログインユーザーは自動的に名前が入力される
- ✅ 匿名投稿も可能

### 2. コメント表示
- ✅ コメント一覧を表示
- ✅ 投稿者の名前（または「匿名」）を表示
- ✅ 投稿日時を相対時間で表示（「たった今」「5分前」など）

### 3. コメント削除
- ✅ 自分のコメントのみ削除可能
- ✅ 確認ダイアログを表示

---

## 📋 セットアップ手順

### ステップ1: Supabaseでコメントテーブルを作成

1. Supabaseダッシュボードにログイン
2. SQL Editorを開く
3. `supabase/migrations/002_create_comments_table.sql`の内容をコピー＆ペースト
4. 「Run」ボタンをクリックして実行

### ステップ2: 環境変数の確認

`.env.local`ファイルに以下が設定されていることを確認：

```env
NEXT_PUBLIC_SUPABASE_URL=your-supabase-url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-supabase-anon-key
```

---

## 🔄 動作の仕組み

### コメントの保存

1. **Supabaseが利用可能な場合:**
   - コメントをSupabaseデータベースに保存
   - 同時にlocalStorageにも保存（オフライン対応・キャッシュ）

2. **Supabaseが利用できない場合:**
   - localStorageに保存（従来通り）

### コメントの取得

1. **Supabaseが利用可能な場合:**
   - Supabaseからコメントを取得
   - 取得したデータをlocalStorageにキャッシュ

2. **Supabaseが利用できない場合:**
   - localStorageから取得

---

## 🔐 セキュリティポリシー（RLS）

作成されたテーブルには以下のRow Level Security（RLS）ポリシーが設定されています：

- ✅ **全ユーザーがコメントを閲覧可能**
- ✅ **全ユーザーがコメントを投稿可能**（匿名投稿も可能）
- ✅ **ユーザーは自分のコメントののみ編集・削除可能**

---

## 📝 使用方法

### コメントを投稿する

1. レビュー詳細ページに移動
2. ページ下部の「コメント」セクションを確認
3. コメント内容を入力
4. 表示名を入力（または「匿名で投稿」にチェック）
5. 「コメントを投稿」ボタンをクリック

### 匿名で投稿する

1. 「匿名で投稿」にチェックを入れる
2. 表示名フィールドは無効化されます
3. 「匿名」としてコメントが投稿されます

### コメントを削除する

1. 自分のコメントの下部に「削除」ボタンが表示されます
2. 「削除」ボタンをクリック
3. 確認ダイアログで「OK」を選択

---

## 📚 関連ファイル

- `supabase/migrations/002_create_comments_table.sql` - コメントテーブル作成SQL
- `lib/comments.ts` - コメント保存・取得の共通関数
- `components/comment-section.tsx` - コメント表示・投稿コンポーネント
- `components/pages/detail-page.tsx` - レビュー詳細ページ（コメントセクションを追加）

---

## 🎨 UIの特徴

### コメント投稿フォーム

- テキストエリアでコメントを入力
- 表示名フィールド（匿名でない場合）
- 「匿名で投稿」チェックボックス
- 投稿ボタン

### コメント表示

- 投稿者名または「匿名」
- 投稿日時（相対時間）
- コメント内容
- 削除ボタン（自分のコメントのみ）

---

**コメント機能の実装が完了しました！各レビューに対してコメントを投稿できるようになりました。**

